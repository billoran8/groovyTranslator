package com.billoran8.groovy.translator

class Translator {

	private static final String ENGLISH_CORPUS = """
	Last week, Don’s downward spiral into alcoholism seemed hopeless. There was just no way you could imagine that he would suddenly decide to enroll in AA, go cold turkey, or disappear to some rehab center. It seemed as if he might be forever fershnickered. And Peggy’s fate seemed just as ominous: She was getting so little respect there seemed no way for her to continue on at SCDP. Both seemed trapped. Last week, there seemed to be no way out. But this week, a mouse somehow wriggles its way into the airtight, glass-and-steel box offices of SCDP. “You know what? There’s a way out of this room we don’t know about,” says Don. As it turns out, he might be right.
The episode was essentially a history-changing two-hander: Peggy vs. Don in the main bout, with Cassius Clay vs. Sonny Liston and a few other supporting characters on the undercard. Only in this episode would the bracingly frank racism—“You’re such a Jew” and “If I wanted to see two Negroes fight, I’d throw a dollar bill out my window”—seem like small potatoes. Only in this show, would it seem barely notable that Bert Cooper’s secretary, Ida Blankenship, was revealed to be the “Queen of Perversions” or that Bert himself was balls-less (turns out Matt Weiner wasn’t taunting his fans with that “Lyle Evans” namedrop a few episodes ago, he was setting up one hell of a joke). Only in this episode could the tenth-most interesting scene be the one in which Duck nearly shat on Roger’s pristine white space chair before striking some batshit Jean-Claude Van Damme I’ve-killed-seventeen-men pose. Has slurring, silly Roger really lost it? Did Liston take a dive for the Mafia? Who cares? Onto the main bout!
The refs debated the rules-bending outcome of Liston-Ali for three hours. We’ll be talking about Olson-Draper for much longer. Peggy warms up for the fight by being disgusted by Duck, who delusionally (if not cruelly) offers her a partnership in a firm that will never be. Don and Peggy's actual fight begins over the suitcase account, but Don ends it quickly with one hell of a knockout blow, a rant as violent as anything written by David “Everyone needs money. That’s why they call it money” Mamet:
Peggy: “But you got the Clio!”
Don: “It’s your job: I give you money, you give me ideas!” 
Peggy: “And you never say thank you.”
Don: “That’s what the money is for!”
Peggy reels from the haymaker: a cruel line about how Peggy should wake up every morning thanking both Don and Jesus. Don instantly regrets it. Their rapprochement is halting. Twice in the episode, Peggy is about to leave the office when she makes the conscious choice to stay, knowing that she'd prefer to stay in the ring. Don is a wreck and Peggy is distracted—they don’t come up with any brilliant ideas. But Don and Peggy both open up about their lives: dead dads and Korea, office rumors and Peggy's dweeby ex-fiance. Then the dams just seem to break when Don talks about how he loves the way you “keep banging your head against the wall and then it happens.” Peggy admits that her personal life, “doesn’t feel right or as important as anything in that office.”
It’s not the most elegant courtship: Don drinks until he throws up and then falls asleep on Peggy’s lap in a vomit-stained shirt. It’s messy (vomit), sad (Peggy’s break-up), contentious (those fights over the campaign), and just plain fucked-up (Duck), but, for these two, that feels about right. Peggy has risen so high, and Don has fallen so far, that maybe they're now meeting in the messy middle. After all they do have so much in common: They're both discreet, kinky, witty, smart, unsentimental, and often ruthlessly critical. They know each other’s secrets, and they both obsessively love the same thing: work. Don has just lost the last semblance of family and can’t figure out his private life; Peggy hates her family and her private life. They're both messes. You wanna judge? Don asks. Of course Peggy doesn't and can't.
At first, it seemed like Don is being painted into the old-fogie corner yet again: Peggy pitches Joe Namath--who is soon to become one of the most potent pantyhose-hawking celebrity endorsers in history—and Don foolishly rejects him. But Don—unlike Peggy, but like the advertising genius George Lois—recognizes that the Ali photo is history in the making (The photo later makes the cover of the Sports Illustrated special issue "The Century’s Greatest Sports Photos’—). But advertising is messy too--bad campaigns are copied as often as good campaigns. Clients often prefer the dumb ideas to the smart ones. The two lines that matter most come when Don, tears streaming, tells Peggy that he’s lost “the only person in the world who really knew [him].” She replies, “That’s not true.” When the angelic ghost of Anna appears in Don’s office, she appears to be giving the new couple her blessing.
But the real moment of affection isn’t the consolation over Anna’s death. It’s the collaboration on the new compaign. “Why are you shitting on this?” Don asks, when Peggy rejects the Sonny-Liston ad. “It’s good, it’s very good,” she says. But does she mean it? Or is Peggy, like Liston, just taking a fall and letting her opponent win? The result is that Don holds her hand. If she is taking a fall to spare his feelings, is it setting up a dynamic that could ruin their relationship before it starts? If it starts? Is Don, so shaken by Anna's death, just desperate to give his life some meaning before he packs his suitcase and heads off into the ether?

Fans keep fantasizing that someday Don and Peggy are going to have that some well-rounded life that’s just eluded them thus far. But neither has had any success building anything outside of the office. So, are they going to fall for each other because they truly love one another? Or because they are two workaholics who can’t imagine a healthy life outside? It’s dangerous to fall for someone because you hope they can save you, particularly if they enable your addiction (though workaholism is much better than alcoholism). Will the relationship, if there is one, become even more of a trap for Peggy?
There’s some reason to think it might work out. The original Draper Daniels dedicated his 1974 memoir, Giants, Pigmies, and Other Advertising People “To Myra, the little giant I married, without whose constant prodding this book would never have been written.” Just as critically, in his last chapter, Daniels imagined “My all-time, All American Advertising Agency,” a list of all the people he respected most. Alongside names like Raymond Rubicam and Sigurd S. Larmon, he included the name Myra Janco Daniels. Draper Daniels’s real wife was, according to her now-defunct website, “the first woman to head up a national advertising firm and the youngest woman to win the National Advertising Federation’s “Advertising Woman of the Year” award. And she was Draper Daniels’s colleague.
You can read Mrs. Draper's lovely essay, “I married a Mad Man,” which details their courtship, here. It recounts how the two met in 1965, when Draper Daniels set up his own company and hired Myra—then an executive vice president—to come work with him via a merger. He served as CEO and creative director, she was COO and marketing director. But before she started, and immediately after their first meeting, Draper Daniels made a bet with a colleague that he would marry Myra within two years. Like Peggy, Myra was engaged at the time, but, she wrote, "I never regretted marrying him, even though I resisted pretty strongly at first,” she wrote. “I think it shows that sometimes we don’t know what’s best for ourselves.” Myra has also said, “the Draper Daniels I knew became a one-woman man after we married. He also quit drinking, when I told him I didn’t want to work with a lush.”
Of course, Myra and Draper are just two far-off inspirations for Peggy and Don. There are too many differences to count, from age to experience to incapacitating drunkenness and preference for prostitutes. Can Peggy and Don be happy together? If they do get together, what about the Moonlighting effect? Will it kill the tension? What will happen to the show if Don stops sleeping around? Or how will fans feel about Don sleeping around on Peggy? Can this work? What about Betty? And if Don and Peggy are just clinging to each other because neither has anyone else, could it end horribly, and soon? Or will nothing come of it. Will Don and Peggy decide, as they have so many other times that this never happened? What do you think?
"""

	public final static String vowels = "aeiouyáéíóúýøäöåæàèìòùăâîůěąęāēīūÆ";
	public final static String consonants = "qwrtpsdfghjklzxcvbnmñčćđšžďňřšťžńśźżÇĝ";
	public final static String upper = "QWERTYUIOPASDFGHJKLZXCVBNM";

	def ivlangMap = [:];
	def mvlangMap = [:];
	def fvlangMap = [:];
	def iclangMap = [:];
	def mclangMap = [:];
	def fclangMap = [:];

	Map referenceLanguage = this.parseCorpus(ENGLISH_CORPUS)
	Map modifyingLanguage = [:]

	def setModifyingCorpus(def modifyingCorpus) {
		this.modifyingLanguage = this.parseCorpus(modifyingCorpus)

		ivlangMap = createLanguageMap(referenceLanguage.ivRefMap, modifyingLanguage.ivRefMap);
		mvlangMap = createLanguageMap(referenceLanguage.mvRefMap, modifyingLanguage.mvRefMap);
		fvlangMap = createLanguageMap(referenceLanguage.fvRefMap, modifyingLanguage.fvRefMap);
		iclangMap = createLanguageMap(referenceLanguage.icRefMap, modifyingLanguage.icRefMap);
		mclangMap = createLanguageMap(referenceLanguage.mcRefMap, modifyingLanguage.mcRefMap);
		fclangMap = createLanguageMap(referenceLanguage.fcRefMap, modifyingLanguage.fcRefMap);
	}

	def parseCorpus(def corp) {

		corp = corp.toLowerCase()

		def refLanguage = [:];
		refLanguage.ivRefMap = [:];
		refLanguage.mvRefMap = [:];
		refLanguage.fvRefMap = [:];
		refLanguage.icRefMap = [:];
		refLanguage.mcRefMap = [:];
		refLanguage.fcRefMap = [:];
		refLanguage.numVows = 0;
		refLanguage.numCons = 0;

		def i = 0
		def key = "";
		def currentType = ""; // v or c
		def vowFlag = "i"; // "i" or "f"
		def conFlag = "i"; // "i" or "f"
		def newLetter = "";
		
		for (i = 0; i <= corp.size(); ++i) {
			if (i < corp.size()) {
				newLetter = corp.charAt(i);
			}
			else { // To catch last letter
				newLetter = "";
			}

			if (vowels.indexOf(newLetter as String ) != -1) {
				if (currentType == "c" && conFlag == "i") {
					// Save off previous key
					if (refLanguage.icRefMap[key] == null) {
						refLanguage.icRefMap[key] = 0;
					}

					refLanguage.icRefMap[key] = refLanguage.icRefMap[key] + 1;
					refLanguage.numCons = refLanguage.numCons + 1;
					key = "";
				} else if (currentType == "c" && conFlag == "f") {
					// Save off previous key
					if (refLanguage.mcRefMap[key] == null) {
						refLanguage.mcRefMap[key] = 0;
					}
					refLanguage.mcRefMap[key] =  refLanguage.mcRefMap[key] + 1;
					refLanguage.numCons = refLanguage.numCons + 1;
					key = "";
				}
				// Keep building current key
				key += (newLetter);
				currentType = "v";
				conFlag = "f";
			} else if (consonants.indexOf(newLetter as String ) != -1) {
				if (currentType == "v" && vowFlag == "i") {
					// Save off previous key
					if (refLanguage.ivRefMap[key] == null) {
						refLanguage.ivRefMap[key] = 0;
					}
					refLanguage.ivRefMap[key] =  refLanguage.ivRefMap[key] + 1;
					refLanguage.numVows = refLanguage.numVows + 1;
					key = "";
				} else if (currentType == "v" && vowFlag == "f") {
					// Save off previous key
					if (refLanguage.mvRefMap[key] == null) {
						refLanguage.mvRefMap[key] = 0;
					}
					refLanguage.mvRefMap[key] =  refLanguage.mvRefMap[key] + 1;
					refLanguage.numVows = refLanguage.numVows + 1;
					key = "";
				}
				// Keep building current key
				key += (newLetter);
				currentType = "c";
				vowFlag = "f";
			} else {
				if (currentType == "c") {
					// Save off previous key
					if (refLanguage.fcRefMap[key] == null) {
						refLanguage.fcRefMap[key] = 0;
					}
					refLanguage.fcRefMap[key] =  refLanguage.fcRefMap[key] + 1;
					refLanguage.numCons = refLanguage.numCons + 1;
					key = "";
				} else if (currentType == "v") {
					// Save off previous key
					if (refLanguage.fvRefMap[key] == null) {
						refLanguage.fvRefMap[key] = 0;
					}
					refLanguage.fvRefMap[key] =  refLanguage.fvRefMap[key] + 1;
					refLanguage.numVows = refLanguage.numVows + 1;
					key = "";
				}
				
				key = "";
				currentType = "";
				conFlag = "i";
				vowFlag = "i";
			}
		}

		return refLanguage

	}

	def createLanguageMap(def refTab, def modTab) {
		def langMap = [:];
		langMap.refTableIndex = 0;
		langMap.modTableIndex = 0;
		langMap.refToRank = [:];
		langMap.rankToMod = [:];
		def newRefMap = refTab.sort {a, b -> b.value <=> a.value};
		def newRefMapM = modTab.sort {a, b -> b.value <=> a.value}

		newRefMap.each { value, index ->
			langMap.refToRank[value] = langMap.refTableIndex; // key is leter, value is rank
			langMap.refTableIndex = langMap.refTableIndex+1;
		}

		newRefMapM.each { value, index ->
			langMap.rankToMod[langMap.modTableIndex] = value; // key is rank, value is letter
			langMap.modTableIndex = langMap.modTableIndex +1;
		}

		return langMap;
	}

	def translateKey(def tkey, def refToRank, def rankToMod, def tCase) {
		def rank = refToRank[tkey];
		def mod = "X";
		if (rank != null) {
			mod = rankToMod[rank];
			if (mod == null) {
				mod = rankToMod[0]; // Default to most common
			}
		} else {

			mod = rankToMod[0]; // Default to most common
		}

		if (tCase == "u") {
			def modA = mod.slice(0,1);
			modA = modA.toUpperCase();
			def modB = mod.slice(1);
			mod = modA+modB;
		}

		return mod;
	}

	def translate(def txt) {
		if (this.modifyingLanguage == [:]) {
			this.setModifyingCorpus(ENGLISH_CORPUS)
		}

		def output = "";
		def i = 0
		def key = "";
		def newLetter = "";
		def keyCase = "l";
		def currentType = ""; // v or c
		def conFlag = "i"; // "i" or "f"
		def vowFlag = "i"; // "i" or "f"

		for (i = 0; i <= txt.size(); ++i) {
			if (i < txt.size()) {
				newLetter = txt.charAt(i);
				if (upper.indexOf(newLetter as String) != -1) {
					newLetter = newLetter.toLowerCase(); // TBD: Remeber case
					keyCase = "u";
				}
			} else {
				newLetter = "";
			}

			if (vowels.indexOf(newLetter as String) != -1) {
				if (currentType == "c" && conFlag == "i") {
					// Translate key
					output = output + translateKey(key,iclangMap.refToRank,iclangMap.rankToMod,keyCase);
					key = "";
					keyCase = "l";
				} else if (currentType == "c" && conFlag == "f") {
					// Translate a Key
					output = output + translateKey(key,mclangMap.refToRank,mclangMap.rankToMod,keyCase);
					key = "";
					keyCase = "l";
				}
				// Keep building current key
				key = key + newLetter;
				currentType = "v";
				conFlag = "f";
			} else if (consonants.indexOf(newLetter as String) != -1) {
				if (currentType == "v" && vowFlag == "i") {
					// Translate key
					output = output + translateKey(key,ivlangMap.refToRank,ivlangMap.rankToMod,keyCase);
					key = "";
					keyCase = "l";
				} else if (currentType == "v" && vowFlag == "f") {
					// Translate a Key
					output = output + translateKey(key,mvlangMap.refToRank,mvlangMap.rankToMod,keyCase);
					key = "";
					keyCase = "l";
				}
				// Keep building current key
				key = key + newLetter;
				currentType = "c";
				vowFlag = "f";
			} else {
				if (currentType == "c") {
					// Translate a Key
					output = output + translateKey(key,fclangMap.refToRank,fclangMap.rankToMod,keyCase) + newLetter;
					key = "";
					keyCase = "l";
				} else if (currentType == "v") {
					// Translate a Key
					output = output + translateKey(key,fvlangMap.refToRank,fvlangMap.rankToMod,keyCase) + newLetter;
					key = "";
					keyCase = "l";
				} else {
					output = output + newLetter;
				}
				// Keep building current key
				key = "";
				keyCase = "l";
				currentType = "";
				conFlag = "i";
				vowFlag = "i";
			}
		}

		return output;
	}



}
